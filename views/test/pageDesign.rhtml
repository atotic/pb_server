<!DOCTYPE html>
<html>
<head>
<title>PageDesign Mockup</title>

<%= asset_link("jquery.js", "application.js") %>
<%= asset_link("gradients.js") %>
<%= asset_link("jquery.hammer.js") %>
<%= asset_link("jquery.dataSelector.js") %>
<%= asset_link("bootstrap") %>
<%= asset_link("application.css") %>
<link href='/css/editor.css' rel='stylesheet' type='text/css' />
<script src="/js/editor.pb.js"></script>
<script src="/js/editor.pb.book.js"></script>
<script src="/js/editor.pb.page.js"></script>
<script src="/js/editor.pb.photos.js"></script>
<script src="/js/editor.gui.js"></script>
<%= asset_link("editor.gui.rect.js") %>
<script src="/js/editor.gui.events.js"></script>
<%= asset_link("editor.gui.commands.js") %>
<script src="/js/editor.gui.popup.js"></script>
<%= asset_link("editor.gui.manipulators.js") %>
<%= asset_link("editor.pb.themecache.js") %>

<style type="text/css">
#tools {
	position: fixed;
	top: 0;
	right: 0px;
	background-color: rgba(255,255,255, 0.7);
	border-width: 0 0 1px 1px;
	border-color: #DDD;
	border-style: solid;
	padding: 8px;
}
.sizePick {
	position: relative;
	border: 1px solid black;
	background-color: #CCC;
	text-align: center;
	padding-top: 16px;
}
#sizePickerContainer {
	vertical-align: top;
	line-height: 80px;
}
#sizePicker {
	display:inline-block;
}
#sizePicker li {
	display: inline-block;
	list-style-type: none;
	margin: 8px;
	vertical-align: bottom;
}
#themePicker li {
	display: inline-block;
	list-style-type: none;

}
#themePicker li img {
	height: 100px;
}
#themePicker li p {
	text-align: center;
}
#backgroundPicker {
	overflow: auto;
	max-height: 160px;
}
#backgroundPicker li {
	display: inline-block;
	list-style-type: none;
}
#layoutPicker {
	overflow: auto;
}
#layoutPicker li {
	display: inline-block;
	list-style-type: none;
	margin-left: 10px;
}
#framePicker {
}
#framePicker li {
	position: relative;
	display: inline-block;
	list-style-type: none;
	margin: 8px;
}
#framePicker li img {
	position: absolute;
}
.design-book-page-left {
	transform: scale(1.0);
	-webkit-transform: scale(1.0);
}
#pagePopupContainer {
	position:relative;
	height: 20px;
}
</style>
<script type="text/javascript">

var BlankPage = {
	width: 512,
	height: 512,
	assets: [],
	assetData: {},
	backgroundId: null,
	backgroundData: null,
	layoutId: null,
	layoutData: null,
	hasLayout: false
}

var book = PB.Book.blank();
var currentPage = book.insertRoughPage(-1);

var Controller = {
	init: function() {
		var THIS = this;
		$.when(
			PB.ThemeCache.load('/t/admin@core/theme.js'),
			PB.ThemeCache.load('/t/admin@sample/theme.js'),
			PB.ThemeCache.load('/t/admin@rotate/theme.js'),
			PB.ThemeCache.load('/t/admin@modern_full/theme.js'),
			PB.ThemeCache.load('/t/admin@sports/theme.js')
			)
			.done( function() {

				new PB.TemplatePhoto.create( {
					id: 'admin@sample/small_soccer',
					originalUrl:  '/t/admin@sample/soccer_small.svg',
					width: 397,
					height: 266
				});
				currentPage.setLayout('theme://admin@core/layouts/gridLayout');
				currentPage.setBackground('theme://admin@core/backgrounds/cssBackground');
				THIS.initThemePicker();
				THIS.initSizePicker();
				THIS.initBackPicker();
				THIS.setDimensions(768, 512);
				THIS.addPhoto();
				// THIS.addText("Very big text\nHas a newline too!")
				// THIS.setLayout('theme://admin@core/layouts/gridLayout');
				THIS.setLayout('theme://admin@rotate/layouts/horizontalLayout');
				THIS.setBackground('theme://admin@sports/backgrounds/soccerField');
				THIS.showPage();
				THIS.updateFramePicker();
			})
			.fail( function() {
				console.error("Themes failed to load");
			});
	},
	initSizePicker: function() {
		var sizes = [
			{ width: 7, height: 5},
			{ width: 4, height: 4 },
			{ width: 8, height: 8 },
			{ width: 12, height: 12},
			{ width: 11, height: 8 }
		];
		function assignCb($el, size) {
			$el.hammer().on('touch', {}, function() {
				Controller.setDimensions(size.width * 96, size.height * 96);
				Controller.updateLayoutPicker();
			});
		};

		var $picker = $('#sizePicker');
		var inchToPixel = 6;
		sizes.forEach(function(size) {
			$li = $('<li>');
			$div = $('<div>')
				.addClass('sizePick')
				.css( { width: size.width * inchToPixel,
					height: size.height * inchToPixel})
				.text(size.width + " X " + size.height);
			$li.append($div);
			$picker.append($li);
			assignCb( $li, size );
		});
	},
	initThemePicker: function() {
		var themeIds = ['admin@modern_full'];
		function assignCb( el, id ) {

		};
		var themesLoading = false;

		themeIds.forEach( function( id) {
			try {
				PB.ThemeCache.get( id, {autoload: true} );
			}
			catch(ex) {
				themesLoading = true;
			}
		});

		if (themesLoading) {
			window.setTimeout( Controller.initThemePicker, 0);
			return;
		}
		var $picker = $('#themePicker');
		themeIds.forEach( function( id) {
			var theme = PB.ThemeCache.get(id, '');
			$li = $('<li>');
			$li.append( $('<img>').prop('src', theme.screenshots[0]));
			$li.append( $('<p>').text( theme.title ));
			$picker.append($li);
			assignCb( $li, id );
		});
	},
	initBackPicker: function() {
		var backs = [
		{ id: 'theme://admin@core/backgrounds/cssBackground',
			name: 'Default'
		},
		{ id: 'theme://admin@core/backgrounds/cssBackground',
			name: 'Yellow',
			data: {
				css: {backgroundColor: 'yellow'}
			}
		},
		{ id: 'theme://admin@core/backgrounds/cssBackground',
			name: 'Rainbow',
			data: {
				css: {background: 'linear-gradient(red, yellow, orange, green, blue, purple)'}
			}
		},
		{ id: 'theme://admin@sports/backgrounds/soccerField' },
		{ id: 'theme://admin@sports/backgrounds/soccerStadium' }

		];
		function assignCb($el, id, data) {
			$el.hammer().on('touch', {}, function() {
				Controller.setBackground(id, data);
			});
		}
		for (var i=0; i<backs.length; i++) {
			var b = PB.ThemeCache.resource(backs[i].id);
			var $li = $('<li>').css({
				width: 100,
				height: 100
			});
			b.fillBackground($li, backs[i].data, {resolution: PB.PhotoProxy.SMALL});
			$('#backgroundPicker').append($li);
			assignCb($li, backs[i].id, backs[i].data);
		};
	},
	updateLayoutPicker: function() {
		$('#layoutPicker').children().remove();
		var layouts = [
		{ id: 'theme://admin@core/layouts/gridLayout',
		},
		{ id: 'theme://admin@core/layouts/gridSpacedLayout',
			data:  {spaceOffset: 10}
		},
		{ id: 'theme://admin@sample/layouts/framedLayout',
			data:  {frameWidth: 10}
		},
		{ id: 'theme://admin@modern_full/layouts/horizontalLayout' },
		{ id: 'theme://admin@modern_full/layouts/verticalLayout' },
		{ id: 'theme://admin@rotate/layouts/horizontalLayout' }


		];
		function assignCb($el, id, data) {
			$el.hammer().on('touch', {}, function() {
				Controller.setLayout(id, data);
				Controller.showPage();
			});
		};
		for (var i=0; i<layouts.length; i++) {

			var icon = PB.ThemeUtils.getLayoutIcon(
				currentPage.p.assetData,
				currentPage.dimensions,
				layouts[i].id,
				layouts[i].data,
				192);
			var $li = $(document.createElement('li'));
			$li.append(icon);
			$('#layoutPicker').append($li);
			assignCb($li, layouts[i].id, layouts[i].data);
		}
	},
	updateFramePicker: function() {
		$('#framePicker').children().remove();
		var frames = [
		{ id: 'theme://admin@core/frames/cssFrame',
			data: {},
			offset: [0, 0, 0, 0]
		},
		{ id: 'theme://admin@core/frames/cssFrame',
			data: {
				css: {
					backgroundColor: 'blue'
				}
			},
			offset: [10, 10, 10, 10]
		},
		{ id: 'theme://admin@core/frames/cssFrame',
			data: {
				css: {
					background: 'linear-gradient(red, yellow, orange, green, blue, purple)'
				}
			},
			offset: [5, 3, 10, 20]
		},
		{ id: 'theme://admin@core/frames/cssFrame',
			data: {
				css: {
					backgroundColor: '#9400d3',
					boxShadow: '5px 5px 5px rgba(148,0,211,0.3)'
				}
			},
			offset: [2, 2, 2, 2]
		}
		];
		var ICON_WIDTH = 50;
		var ICON_HEIGHT = 50;

		function assignCb($el, frameId, frameData, frameOffset) {
			$el.hammer().on('touch', {}, function() {
				PB.PageSelection.forEach(function(page, itemId) {
					var assetData = page.getAssetData(itemId);
					assetData.frameId = frameId;
					assetData.frameData = frameData;
					assetData.frameOffset = frameOffset;
					page.updateAssetData(itemId, assetData, {clobber: true});
				});
			});
		};

		for (var i=0; i<frames.length; i++) {
			var f = PB.ThemeCache.resource(frames[i].id);
			var $li = $('<li>');

			var $frameDiv = $('<div>').css({
				width: ICON_WIDTH,
				height: ICON_HEIGHT
			});
			f.fillFrame($frameDiv, frames[i].offset, frames[i].data, {});

			var offset = PB.ThemeUtils.canonicalFrameWidth(frames[i].offset);
			var imgRect = new GUI.Rect({width: ICON_WIDTH, height: ICON_HEIGHT});
			imgRect = imgRect.inset(offset);
			$img = $('<img>');
			$img.attr('src', PB.FillerPhotos.randomH(0).url)
				.css({
					top: imgRect.top,
					left: imgRect.left,
					width: Math.max(10, imgRect.width),
					height: Math.max(10, imgRect.height)
				});
			$li.append($frameDiv);
			$li.append($img);
			$('#framePicker').append($li);
			assignCb($li, frames[i].id, frames[i].data, frames[i].offset);
		}
	},
	showPage: function() {
		var options = {
			editable: $('#editable').prop('checked'),
			syncable: $('#syncable').prop('checked')
		};
		var dom = currentPage.generateDom(options);
		$('.design-book-page-left').children().remove();
		$('.design-book-page-left').append(dom);
		this.updateLayoutPicker();
	},
	addPhoto: function() {
		currentPage.addPhoto(PB.FillerPhotos.random().id);
		this.updateLayoutPicker();
	},
	removePhoto: function() {
		PB.PageSelection.getActiveSelections().forEach(function(pageSel) {
			pageSel.selection.forEach(function(itemId) {
				pageSel.bookPage.removeAsset(itemId);
			});
			pageSel.setSelection();
		});
		this.updateLayoutPicker();
	},
	words: ["one", "two", "and a much longer three, how much longer i am not sure"],
	addText: function(text) {
		var word = text;
		if (word === undefined) {
			word = this.words.shift();
			this.words.push(word);
		}
		currentPage.addText();
		this.updateLayoutPicker();
	},
	addWidget: function() {
		currentPage.addWidget('theme://admin@sports/widgets/soccerBallWidget');
		// currentPage.addWidget('theme://admin@core/widgets/photoWidget',
		// 	{ photoId: 'admin@sample/small_soccer'});
	},
	setLayout: function(layoutId, layoutData) {
		currentPage.setLayout(layoutId, layoutData);
	},
	setBackground: function(backgroundId, backgroundData) {
		currentPage.setBackground(backgroundId, backgroundData);
	},
	setDimensions: function(width, height) {
		book.setDimensions( width, height );
	}
}

$(document).ready(function() {
	Controller.init();
	GUI.CommandManager.init();
//	$(document.body).css('background', 'linear-gradient(45deg, red, blue)');
});
</script>
<body>
	<div id='tools'>
		<label for='editable'>Editable <input type='checkbox' id='editable' checked onClick='Controller.showPage()'/></label>
		<label for='syncable'>syncable <input type='checkbox' id='syncable' checked onClick='Controller.showPage()'/></label>
		<button onclick="Controller.addPhoto()">Add photo</button><br>
		<button onclick="Controller.removePhoto()">Remove</button><br>
		<button onclick="Controller.addText()">Add text</button><br>
		<button onclick="Controller.addWidget()">Add widget</button>
	</div>
	<div id='sizePickerContainer'>What size would you like your book to be?
	<ul id='sizePicker'>
	</ul>
	</div>
	<p>And theme? You can mix in other themes later.</p>
	<ul id='themePicker'>
	</ul>
	<p>Layouts:</p>
	<ul id='layoutPicker'>
	</ul>
	<p>Backgrounds:</p>
	<ul id='backgroundPicker'>
	</ul>
	<p>Frames</p>
	<ul id='framePicker'>
	</ul>
	<div id='pagePopupContainer'></div>
	<div class='design-book-page-left' ></div>
</body>
