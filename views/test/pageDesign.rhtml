<html>
<head>
<title>PageDesign Mockup</title>

<%= asset_link("application.css") %>
<%= asset_link("jquery.js", "application.js") %>
<%= asset_link("bootstrap") %>
<%= asset_link("application.css") %>
<%= asset_link("jquery.js", "application.js") %>
<%= asset_link("bootstrap") %>
<link href='/css/application.css' rel='stylesheet' type='text/css' />
<link href='/css/editor.css' rel='stylesheet' type='text/css' />
<script src="/js/editor.pb.js"></script>
<script src="/js/editor.gui.js"></script>
<style type="text/css">
</style>
<script type="text/javascript">
"use strict"


var IntegerArithmetic = {
	// line gets divided into segmentCount,
	// segments are forced to integer length
	// return: [segmentCount + 1] of segment terminating points
	segmentLine: function(line, segmentCount) {
		if (isNaN(segmentCount) || segmentCount == 0)
			return [];
		var rem = line % segmentCount;
		var segLength = Math.round((line - rem) / segmentCount);
		var segments = new Array(segmentCount + 1);
		segments[0] = 0;
		for (var i=1; i<= segmentCount; i++) {
			var padding = 0;
			if (rem > 0) { // pad each segment by 1 until no more extra pixels
				padding += 1;
				rem -=1;
			}
			segments[i] = segments[i-1] + segLength + padding;
		}
		return segments;
	}
}


var PhotoCache = {
	cache: {},
	put: function(photo) {
		this.cache[photo.id] = photo;
	},
	get: function(id) {
		if (id in this.cache)
			return this.cache[id];
		throw "No such photo" + id;
	},
	random: function(id) {
		var props = [];
		for (var p in this.cache)
			props.push(p);
		return this.cache[props[Math.floor(Math.random() * props.length)]];
	}
}

var Photo = function(id, url, width, height) {
	this.id = id;
	this.url = url;
	this.width = width;
	this.height = height;
}


var BlankPage = {
	width: 768,
	height: 512,
	assets: [],
	assetData: {},
	backgroundId: null,
	backgroundOptions: null,
	layoutId: null,
	layoutOptions: null,
	hasLayout: false
}
// AbstractLayout documents minimal layout class looks like. not functional
var AbstractLayout = {
	id: '',
	// assetData from book-page, read-only
	// page width/height 
	// options are layout-dependent (ex inset....)
	getPageLayout: function(assetData, width, height, options) {
		return {
			design: [ {
				top: 0, left: 0, width: 0, height: 0, type: 'photo'
			}],
			background: {
				id: '',
				data: {
					// background-specific data
				}
			}
		}
	}
};

var ThemeCache = {
	cache: {},
	get: function(id) {
		if (id in this.cache) 
			return this.cache[id];
		throw "No such theme " + id;
	},
	put: function(theme) {
		if (theme.id in this.cache) 
			throw "theme already defined " + theme.id; 
		this.cache[theme.id] = theme;
	},
	themeRegex: new RegExp("^theme\:\/\/([^\/]+)/(.*)$"),
	// Resource url scheme
	// theme://theme_id/:res_type/:res_id
	resource: function(resUrl) {
		var match = this.themeRegex.exec(resUrl);
		if (!match) {
			var err = "Malformed theme resource url " + resUrl; console.error(err); throw err;
		}
		var themeId = match[1],
			pathStr = match[2];
		var theme = this.cache[themeId];
		if (!theme) {
			var err = "Theme not found " + resUrl; console.error(err); throw err;
		}
		var p,
			res = theme,
			path = pathStr.split('/');
		while (p = path.shift()) {
			res =  res[p];
			if (res === undefined) {
				var err = "Resource not found  " + resUrl + " problem: " + p; console.error(err); throw err;
			}
		}
		return res;
	}
};


// Base Theme
(function(themeCache) {
	var GridLayout = {
		id: 'gridLayout',
		getPageLayout: function(assetData, width, height, options) {
			options = $.extend({inset: 0}, options);
			width = Math.max(width - 2 * options.inset, 0);
			height = Math.max(height - 2 * options.inset, 0);
			if (!width || width < 50 || !height || height < 50) {
				console.error('getPageLayout width/height too small', width, height);
				return;
			}
			// Generate optimum tiles
			var photoCount = AssetDataUtils.photoCount(assetData);
			var textCount = AssetDataUtils.textCount(assetData);
			var totalCount = photoCount + textCount;
			var tileCountH = Math.round(Math.sqrt(totalCount * width / height));
			var tileCountV = Math.ceil(totalCount / tileCountH);
			var widthSegments = IntegerArithmetic.segmentLine(width, tileCountH);
			var heightSegments = IntegerArithmetic.segmentLine(height, tileCountV);
			var design = [];
			for (var v=0; v < tileCountV; v++) {
				for (var h=0; h < tileCountH; h++) {
					var imgIdx = v * tileCountH + h;
					if (imgIdx >= totalCount)
						break;
					var assetData = {
						top: options.inset + heightSegments[v],// v * tileHeight,
						left: options.inset + widthSegments[h], //h * tileWidth,
						height: heightSegments[v+1] - heightSegments[v], //tileHeight
						width: widthSegments[h+1] - widthSegments[h] //tileWidth,
					}
					console.log(assetData);
					if (imgIdx < photoCount) {
						assetData.type = 'photo';
						design.push(assetData);
					}
					else {
						assetData.type = 'text';
						design.push(assetData);
					}
				}
			}
			return {
				design: design
			}
		}
	};

	var GridFrameLayout = {
		id: 'gridFrameLayout',
		getPageLayout: function(assetData, width, height, options) {
			options = $.extend({
				frameOffset: 0	
			}, options);
			var layout = GridLayout.getPageLayout(assetData, width, height, $.extend({ inset: options.frameOffset}, options));
			var design = layout.design;
			for (var i=0; i < design.length; i++) {
				design[i].top += options.frameOffset;
				design[i].left += options.frameOffset;
				design[i].width -= options.frameOffset * 2;
				design[i].height -= options.frameOffset * 2;
			}
			return layout;
		},
	};

	var CSSBackground = {
		id: 'cssBackground',
		sampleOption: {
			css: {
				backgroundColor: 'transparent',
				backgroundPosition : '0% 0%',
				backgroundSize: 'auto auto',
				backgroundRepeat: 'repeat',
				backgroundClip: 'border-box',
				backgroundImage: '$IMG'	// Image URLs are substituted with appropriate resolution
			},
			imageSubstitution: {
				$IMG: {
					small: '',
					display: '',
					original: ''
				}
			}
		},

		fillBackground: function( $div, options) {
			options = $.extend({ 
				css: { // from http://lea.verou.me/css3patterns/#weave
					background: 'linear-gradient(135deg, #708090 22px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px), linear-gradient(225deg, #708090 22px, #d9ecff 22px, #d9ecff 24px, transparent 24px, transparent 67px, #d9ecff 67px, #d9ecff 69px, transparent 69px) 0 64px',
backgroundColor: '#708090',
backgroundSize: '64px 128px'
				}
			}, options);
			if (options.css.backgroundImage) {
				var defaultSize = 'original';
				var match = options.css.backgroundImage.match(/(\$[\w]+)/g);
				for (var i=0; i<match.length; i++) {
					if (match[i] in options.imageSubstitution) {
						debugger;	// need url substitution here
						options.css.backgroundImage = options.css.backgroundImage.replace(match[i], options.imageSubstitution[p][defaultSize]);
					}
					else {
						console.error("unable to substitute css image " + match[i]);
						debugger;
					}
				}
			}
			$div.css(options.css);
		}

	};
	var BaseTheme = {
		id: 'base',
		layouts: {
			gridLayout : GridLayout,
			gridFrameLayout : GridFrameLayout
		},
		backgrounds: {
			cssBackground: CSSBackground
		}
	 };
	 themeCache.put(BaseTheme)
})(ThemeCache);


var Book = {
}


var AssetDataUtils = {
	genericCount: function(assetData, type) {
		var c = 0;
		for (var p in assetData)
			if (assetData[p].type === type)
				c++;
		return c;
	},
	photoCount: function(assetData) {
		return this.genericCount(assetData, 'photo');
	},
	textCount: function(assetData) {
		return this.genericCount(assetData, 'text');
	}
}
var BookPage = function(book, bookPage) {
	this.book = book;
	this.data = bookPage;
};

BookPage.prototype = {
	get p() {
		return this.data;
	},
	get width() {
		return this.p.width;
	},
	get height() {
		return this.p.height;
	},
	addAsset: function(id, assetData) {
		this.p.assets.push(id);
		this.p.assetData[id] = assetData;
		this.p.hasLayout = false;
	},
	addPhoto: function(id) {
		var data = {
			type: 'photo',
			photoId: id
		};
		this.addAsset(PB.randomString(6), data);
	},
	addText: function() {
	},
	setLayout: function(layoutId, layoutOptions) {
		this.p.layoutId = layoutId;
		this.p.layoutOptions = layoutOptions;
		this.hasLayout = false;
	},
	setBackground: function(backgroundId, backgroundOptions) {
		this.p.backgroundId = backgroundId;
		this.p.backgroundOptions = backgroundOptions;
	},
	enclosingDom: function(options) {
		return $(document.createElement('div'))
				.addClass('designPage')
				.css({
					width: this.width,
					height: this.height
				});
	},
	layoutFromDesign: function() {
		this.hasLayout = false;
		if (!this.p.layoutId)
			return;
		var design = ThemeCache.resource(this.p.layoutId);
		var layout =  design.getPageLayout(this.p.assetData, this.width, this.height, this.p.layoutOptions);
		var designData = layout.design;
		for (var i=0; i<this.p.assets.length; i++) {
			var dd = designData.shift();
			var assetData = this.p.assetData[this.p.assets[i]];
			var photo = PhotoCache.get(assetData.photoId)
			var photoRect = new GUI.Rect(photo);
			var scale = photoRect.fillInside(dd);
			photoRect = photoRect.scaleBy(scale).centerIn(dd).round();
			$.extend(this.p.assetData[this.p.assets[i]],{
				type: 'photo',
				top: dd.top,
				left: dd.left,
				width: dd.width,
				height: dd.height,
				photoRect: {
					top: photoRect.top,
					left: photoRect.left,
					width: photoRect.width,
					height: photoRect.height
				}
			});
		}
		if (layout.background) {
			this.p.backgroundId = layout.background.backgroundId;
			this.p.backgroundData = layout.background.backgroundData;
		}
		this.p.hasLayout = true;
	},
	/*
	photoAsset JSON{
		type: 'photo'
		top
		left
		width
		height
		photoId
		photoRect { tlwh }
		frameId
		frameOffset { tlwh }
	}
	photoDom {
		div.design-photo top: left: width: height	// photo with frame
			div.design-photo-frame top: 0, left: 0, width: height:
			div.design-photo-inner top: left: width: height: // photo enclosure, no overflow, position absolute
				img.design-photo-img top: left: width: height: // just photo
	}
	*/
	generatePhotoDom: function(photoAsset, options) {
		var designPhoto = $(document.createElement('div'))
			.addClass('design-photo')
			.css({
				top: photoAsset.top,
				left: photoAsset.left,
				width: photoAsset.width,
				height: photoAsset.height
			});
		// overlapFudge hack grows images by .5 of a pixel
		// without it, there could be a small gap between adjacent images
		var overlapFudge = 0;
		var designPhotoInner = $(document.createElement('div'))
			.addClass('design-photo-inner')
			.css({
				top: 0,
				left: 0,
				width: photoAsset.width + overlapFudge,
				height: photoAsset.height + overlapFudge
			});
		var img = $(document.createElement('img'))
			.addClass('design-photo-img')
			.prop('src', PhotoCache.get(photoAsset.photoId).url)
			.css({
				top: photoAsset.photoRect.top,
				left: photoAsset.photoRect.left,
				width: photoAsset.photoRect.width + overlapFudge,
				height: photoAsset.photoRect.height + overlapFudge
			});
		designPhoto.append(designPhotoInner.append(img));
		return designPhoto;
	},
	/*
	.design-book-page-left
		.design-page, css transform(scale), width, height
			.design-photo
	*/
	generateDom: function(options) {
		options = $.extend({
			sync: false,	//
			editable: false
		}, options);
		var encloseDom = this.enclosingDom(options);
		if (this.p.hasLayout)
		{	// layout all parts of the page
			var p = this.p;
			if (p.backgroundId) {
				ThemeCache.resource(p.backgroundId).fillBackground(encloseDom, p.backgroundOptions);
			}
			for (var i=0; i < p.assets.length; i++) {
				var item = p.assetData[p.assets[i]];
				var itemDom;
				switch(item.type) {
					case 'photo':
						itemDom = this.generatePhotoDom(item, options);
						break;
					default:
						debugger;
				}
				encloseDom.append(itemDom);
			}
		}
		else
			encloseDom.text("Design not available." + this.p.assets.length + " items on this page");
		return encloseDom;
	}
}

var currentPage = new BookPage(Book, BlankPage);
var Util = {
	init: function() {
		PhotoCache.put(new Photo('h1', '/img/h1.png', 723, 541));
		PhotoCache.put(new Photo('h2', '/img/h2.png', 717, 538));
		PhotoCache.put(new Photo('h3', '/img/h3.png', 751, 561));
		PhotoCache.put(new Photo('h4', '/img/h4.png', 718, 538));
		PhotoCache.put(new Photo('h5', '/img/h5.png', 710, 533));
		PhotoCache.put(new Photo('h6', '/img/h6.png', 719, 534));
		PhotoCache.put(new Photo('v1', '/img/v1.png', 785, 1127));
		PhotoCache.put(new Photo('v2', '/img/v2.png', 483, 646));
		PhotoCache.put(new Photo('v3', '/img/v3.png', 484, 650));
		PhotoCache.put(new Photo('v4', '/img/v4.png', 482, 644));
	},
	showPage: function() {
		var dom = currentPage.generateDom();
		$('.design-book-page-left').children().remove();
		$('.design-book-page-left').append(dom);
	},
	addPhoto: function() {
		var	photoUrls = ["h1.png", "h2.png", "h3.png", "h4.png", "h5.png", "h6.png", "v1.png", "v2.png", "v3.png", "v4.png"];
		var url = '/img/' + photoUrls[Math.floor(Math.random() * photoUrls.length)];
		currentPage.addPhoto(PhotoCache.random().id);
		currentPage.layoutFromDesign();
		this.showPage();
	},
	setLayout: function(layoutId, layoutOptions) {
		currentPage.setLayout(layoutId, layoutOptions);
		currentPage.layoutFromDesign();
		this.showPage();
	},
	setBackground: function(backgroundId, backgroundData) {
		currentPage.setBackground(backgroundId, backgroundData);
		this.showPage();
	},
}
$(document).ready(function() {
	Util.init();
	Util.showPage();
});
</script>
<body>
	<button onclick="Util.addPhoto()">Add photo</button>
	<button onclick="Util.removePhoto()">Remove photo</button>
	<button onclick="Util.addText()">Add text</button>
	<button onclick="Util.setLayout('theme://base/layouts/gridLayout')">Set gridLayout</button>
	<button onclick="Util.setLayout('theme://base/layouts/gridFrameLayout', {frameOffset: 10})">Set gridFrameLayout 10</button>
	<button onclick="Util.setLayout('theme://base/layouts/gridFrameLayout', {frameOffset: 20})">Set gridFrameLayout 20</button>
	<button onclick="Util.setBackground('theme://base/backgrounds/cssBackground', {})">Set default css background 20</button>
	<button onclick="Util.setBackground('theme://base/backgrounds/cssBackground', { css: {backgroundColor: 'yellow'}})">Set yellow css background 20</button>

	<div class='design-book-page-left'></div>
</body>
